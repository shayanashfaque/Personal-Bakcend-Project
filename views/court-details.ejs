<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title><%= court.name %> - Details | Footlinks</title>
  <style>
    body {
      font-family: 'Segoe UI', sans-serif;
      background-color: #f8f9fa;
      margin: 0;
      padding: 2rem;
    }

    .court-container {
      max-width: 900px;
      margin: 0 auto;
      background: white;
      padding: 2rem;
      border-radius: 16px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    }

    h1 {
      color: #0a6847;
      margin-bottom: 0.5rem;
    }

    p {
      margin: 0.5rem 0;
    }

    .court-images {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 1rem;
      margin: 1rem 0 2rem;
    }

    .court-images img {
      width: 100%;
      height: 180px;
      object-fit: cover;
      border-radius: 10px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }

    .upload-form {
      margin-top: 1.5rem;
      background-color: #f1f1f1;
      padding: 1rem;
      border-radius: 10px;
    }

    .slots-container {
      margin-top: 2rem;
    }

    .slot {
      display: flex;
      justify-content: space-between;
      background: #e8f5e9;
      padding: 0.8rem 1rem;
      border-radius: 8px;
      margin-bottom: 0.5rem;
      align-items: center;
    }

    .slot.booked {
      background: #f8d7da;
      text-decoration: line-through;
      color: #555;
    }

    button {
      background-color: #0a6847;
      color: white;
      border: none;
      padding: 0.5rem 1rem;
      border-radius: 6px;
      cursor: pointer;
    }

    button:hover {
      background-color: #085c3f;
    }

    button:disabled {
      background-color: #ccc;
      cursor: not-allowed;
    }

    .back-link {
      display: inline-block;
      margin-top: 1.5rem;
      color: #0a6847;
      text-decoration: none;
      font-weight: 600;
    }

    .back-link:hover {
      text-decoration: underline;
    }

    /* Ratings & Comments styles */
    .ratings-comments {
      margin-top: 2rem;
    }

    .ratings-comments ul {
      list-style: none;
      padding: 0;
    }

    .ratings-comments li {
      background: #f1f1f1;
      padding: 1rem;
      border-radius: 10px;
      margin-bottom: 1rem;
    }

    .ratings-comments strong {
      font-weight: 700;
    }
  </style>
</head>
<body>
  <div class="court-container">
    <h1><%= court.name %></h1>
    <p><strong>üìç Location:</strong> <%= court.location %></p>
    <p><strong>üíµ Price/hour:</strong> $<%= court.pricePerHour %></p>
    <p><strong>‚≠ê Average Rating:</strong> <%= averageRating %> / 5</p>

    <% if (court.images && court.images.length > 0) { %>
      <div class="court-images">
        <% court.images.forEach(img => { %>
          <img src="<%= img %>" alt="Court image" />
        <% }) %>
      </div>
    <% } else { %>
      <div class="court-images">
        <img src="https://via.placeholder.com/800x400?text=No+Images+Uploaded" alt="No images available" />
      </div>
    <% } %>

    <% if (
      typeof user !== 'undefined' && user &&
      (
        user.role === "Admin" ||
        (court.owner && (
          (court.owner._id && user._id && court.owner._id.toString() === user._id.toString()) ||
          (typeof court.owner === "string" && court.owner === user._id.toString())
        ))
      )
    ) { %>
      <div class="upload-form">
        <h3>Upload Court Images</h3>
        <form action="/courts/<%= court._id %>/upload" method="POST" enctype="multipart/form-data">
          <input type="file" name="images" multiple required />
          <button type="submit">Upload Images</button>
        </form>
      </div>
    <% } %>

    <div class="slots-container">
      <h2>Available Slots</h2>

      <div style="margin-bottom: 1rem;">
        <label for="datePicker">Select Date: </label>
        <input type="date" id="datePicker" />
      </div>

      <div id="slotsList">
        <p>Loading slots...</p>
      </div>
    </div>

    <!-- Ratings & Comments Display Only -->
    <div class="ratings-comments">
      <h2>Ratings & Comments</h2>

      <% if (ratings && ratings.length > 0) { %>
        <ul>
          <% ratings.forEach(r => { %>
            <li>
              <strong><%= r.user && r.user.name ? r.user.name : 'User' %></strong>
              <span>‚≠ê <%= r.rating %> / 5</span>
              <p><%= r.comment %></p>
            </li>
          <% }) %>
        </ul>
      <% } else { %>
        <p>No ratings or comments yet.</p>
      <% } %>
    </div>

    <a href="/courts" class="back-link">‚Üê Back to Courts</a>
  </div>

  <script>
    document.addEventListener('DOMContentLoaded', function() {
      const datePicker = document.getElementById('datePicker');
      const slotsList = document.getElementById('slotsList');
      const courtId = '<%= court._id %>';

      function fetchSlots(date) {
        fetch(`/courts/${courtId}/slots?date=${date}`)
          .then(response => response.json())
          .then(data => {
            slotsList.innerHTML = '';
            if (data.length === 0) {
              slotsList.innerHTML = '<p>No slots available for this date.</p>';
            } else {
              data.forEach(slot => {
                const slotDiv = document.createElement('div');
                slotDiv.className = `slot ${slot.isBooked ? 'booked' : ''}`;
                slotDiv.innerHTML = `
                  <span>${slot.startTime} - ${slot.endTime} ($${slot.price})</span>
                  ${slot.isBooked ? '<button disabled>Booked</button>' : `
                    <form action="/courts/${courtId}/book/${slot._id}" method="POST" style="display:inline;">
                      <button type="submit">Book Now</button>
                    </form>
                  `}
                `;
                slotsList.appendChild(slotDiv);
              });
            }
          })
          .catch(error => {
            console.error('Error fetching slots:', error);
            slotsList.innerHTML = '<p>Error loading slots. Please try again.</p>';
          });
      }

      const today = new Date().toISOString().split('T')[0];
      datePicker.value = today;
      fetchSlots(today);

      datePicker.addEventListener('change', function() {
        const selectedDate = datePicker.value;
        if (selectedDate) {
          fetchSlots(selectedDate);
        }
      });
    });
  </script>
</body>
</html>